#!/usr/bin/env node
const { exec } = require('child_process')

function ex(com) {
	return new Promise((resolve, reject) => {
		exec(com, (err, stdout, stderr) => {
			resolve(`[{"pid":21716,"name":"ovh-dynhost","pm2_env":{"env_production":{"NODE_ENV":"production"},"kill_retry_time":100,"windowsHide":true,"username":"mathias","treekill":true,"automation":true,"pmx":true,"instance_var":"NODE_APP_INSTANCE","watch":false,"autorestart":true,"vizion":true,"instances":1,"max_memory_restart":1073741824,"env":{"PM2_JSON_PROCESSING":"true","PM2_USAGE":"CLI","OLDPWD":"/home/mathias","_":"/home/mathias/.nvm/versions/node/v9.11.2/bin/pm2","SSH_TTY":"/dev/pts/1","NVM_BIN":"/home/mathias/.nvm/versions/node/v9.11.2/bin","DBUS_SESSION_BUS_ADDRESS":"unix:path=/run/user/1000/bus","PATH":"/home/mathias/.local/bin:/home/mathias/.nvm/versions/node/v9.11.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin","XDG_DATA_DIRS":"/usr/local/share:/usr/share:/var/lib/snapd/desktop","SSH_CLIENT":"192.168.1.4 49633 22","XDG_RUNTIME_DIR":"/run/user/1000","XDG_SESSION_ID":"305","NVM_CD_FLAGS":"","SHLVL":"1","USER":"mathias","LESSOPEN":"| /usr/bin/lesspipe %s","TERM":"xterm-256color","XDG_SESSION_CLASS":"user","LESSCLOSE":"/usr/bin/lesspipe %s %s","NVM_DIR":"/home/mathias/.nvm","SSH_CONNECTION":"192.168.1.4 49633 192.168.1.2 22","LS_COLORS":"rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:","LANG":"en_US.UTF-8","HOME":"/home/mathias","MOTD_SHOWN":"pam","XDG_SESSION_TYPE":"tty","LOGNAME":"mathias","PWD":"/home/mathias/git/ovh-dynhost","EDITOR":"vim","THEME":"e[32m","SHELL":"/bin/bash","NODE_ENV":"development","PM2_HOME":"/home/mathias/.pm2","ovh-dynhost":"{}","unique_id":"f2f806c0-6470-4011-8194-c34a6be62413"},"name":"ovh-dynhost","node_args":[],"pm_exec_path":"/home/mathias/git/ovh-dynhost/index.js","pm_cwd":"/home/mathias/git/ovh-dynhost","exec_interpreter":"node","exec_mode":"fork_mode","pm_out_log_path":"/home/mathias/.pm2/logs/ovh-dynhost-out-0.log","pm_err_log_path":"/home/mathias/.pm2/logs/ovh-dynhost-error-0.log","pm_pid_path":"/home/mathias/.pm2/pids/ovh-dynhost-0.pid","km_link":false,"vizion_running":false,"NODE_APP_INSTANCE":0,"PM2_JSON_PROCESSING":"true","PM2_USAGE":"CLI","OLDPWD":"/home/mathias","_":"/home/mathias/.nvm/versions/node/v9.11.2/bin/pm2","SSH_TTY":"/dev/pts/1","NVM_BIN":"/home/mathias/.nvm/versions/node/v9.11.2/bin","DBUS_SESSION_BUS_ADDRESS":"unix:path=/run/user/1000/bus","PATH":"/home/mathias/.local/bin:/home/mathias/.nvm/versions/node/v9.11.2/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin","XDG_DATA_DIRS":"/usr/local/share:/usr/share:/var/lib/snapd/desktop","SSH_CLIENT":"192.168.1.4 49633 22","XDG_RUNTIME_DIR":"/run/user/1000","XDG_SESSION_ID":"305","NVM_CD_FLAGS":"","SHLVL":"1","USER":"mathias","LESSOPEN":"| /usr/bin/lesspipe %s","TERM":"xterm-256color","XDG_SESSION_CLASS":"user","LESSCLOSE":"/usr/bin/lesspipe %s %s","NVM_DIR":"/home/mathias/.nvm","SSH_CONNECTION":"192.168.1.4 49633 192.168.1.2 22","LS_COLORS":"rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:","LANG":"en_US.UTF-8","HOME":"/home/mathias","MOTD_SHOWN":"pam","XDG_SESSION_TYPE":"tty","LOGNAME":"mathias","PWD":"/home/mathias/git/ovh-dynhost","EDITOR":"vim","THEME":"e[32m","SHELL":"/bin/bash","NODE_ENV":"development","PM2_HOME":"/home/mathias/.pm2","ovh-dynhost":"{}","unique_id":"f2f806c0-6470-4011-8194-c34a6be62413","status":"online","pm_uptime":1582193639776,"axm_actions":[],"axm_monitor":{},"axm_options":{"error":true,"heapdump":false,"feature.profiler.heap_snapshot":false,"feature.profiler.heap_sampling":false,"feature.profiler.cpu_js":false,"latency":true,"catchExceptions":true,"profiling":true,"metrics":{"http":true,"runtime":true,"eventLoop":true,"network":false,"v8":true},"standalone":false,"tracing":{"outbound":false,"enabled":false},"module_conf":{},"apm":{"version":"4.2.6","type":"node"},"module_name":"ovh-dynhost","module_version":"3.5.1"},"axm_dynamic":{},"created_at":1582193639776,"pm_id":0,"restart_time":3,"unstable_restarts":0,"version":"1.0.0","node_version":"9.11.2","versioning":{"type":"git","url":"https://github.com/maathias/ovh-dynhost","revision":"1ec33864ab6da97166a90a201677f0b0492a4416","comment":"switch to ipify.org","unstaged":true,"branch":"master","remotes":["origin"],"remote":"origin","branch_exists_on_remote":true,"ahead":false,"next_rev":null,"prev_rev":"c95cecd241ea29768838a5b452cc8b4c627f4f98","update_time":"2020-02-20T10:14:01.298Z","repo_path":"/home/mathias/git/ovh-dynhost"}},"pm_id":0,"monit":{"memory":40464384,"cpu":9.1}}]`)
			if (stderr) reject(stderr)
			resolve(stdout)
		})
	})
}

ex('pm2 jlist').then(out => {
	out = JSON.parse(out)
	
	console.log()
	console.log(`PM2 Services:`)
	for(let service of out){
		console.log(` \x1b[1m${service.name}\x1b[0m ${service.pm2_env.status != 'online' ? '\x1b[31m' : '\x1b[32m'}${service.pm2_env.status}\x1b[0m ${service.monit.cpu}% ${~~(service.monit.memory / 1024 / 1024)} MB${service.pm2_env.restart_time > 0 ? ` \x1b[33m${service.pm2_env.restart_time} â†º \x1b[0m` : ''}`)	
	}
	
})
